<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Clubs Map</title>

    <style>
        #map {
            height: 80vh;
            width: 100%;
        }
        #filter-container {
            text-align: center;
            margin: 10px;
        }
       select {
    font-size: 12px;  /* âœ… Smaller font for compact design */
    padding: 5px;
    width: 280px;  /* âœ… Widen the box */
    height: auto; /* âœ… Expands when selecting multiple options */
    max-height: 120px; /* âœ… Shows multiple selected options */
    overflow-y: auto; /* âœ… Enables scrolling only if too many options */
}

/* âœ… Ensures each option is clearly visible */
#filter option {
    font-size: 12px; /* âœ… Matches the smaller font */
    padding: 4px;
    white-space: nowrap; /* âœ… Prevents text from wrapping */
}


/* âœ… Ensures each option is clearly visible */
#filter option {
    font-size: 14px; /* âœ… Keeps text readable */
    padding: 5px;
    white-space: nowrap; /* âœ… Prevents text from wrapping */
}


/* âœ… Improves spacing inside the dropdown */
#filter option {
    font-size: 14px; /* âœ… Matches smaller text */
    padding: 5px;
    white-space: nowrap; /* âœ… Prevents text from wrapping */
}


/* âœ… Ensures text is fully visible */
#filter option {
    padding: 8px;
    white-space: nowrap; /* âœ… Prevents text from wrapping */
}


#filter-container {
    text-align: center;
    margin: 10px;
}

/* âœ… Makes multiple selections clearer */
#filter option {
    padding: 5px;
}
/* âœ… Style for the filter wrapper */
#filters-wrapper {
    display: flex;  
    justify-content: center; /* Centers the filters */
    gap: 15px; /* Adds spacing between filters */
    margin: 10px 0;
}

/* âœ… Ensures each filter is properly spaced */
.filter-box {
    display: flex;
    flex-direction: column; /* Keeps label above dropdown */
    align-items: center;
}

/* âœ… Adjusts dropdown styling */
#filter, #region-filter {
    font-size: 12px;
    padding: 5px;
    width: 200px;  /* âœ… Make both filters the same width */
    height: auto;
    max-height: 120px;
    overflow-y: auto;
}
    </style>
</head>
<body>

    <!-- ðŸ”¹ FILTER DROPDOWN -->
  <!-- âœ… Wrap both filters in a new container -->
<div id="filters-wrapper">
    <!-- Club Filter -->
    <div class="filter-box">
        <label for="filter">Club Size:</label>
        <select id="filter" multiple onchange="filterMarkers()">
            <option value="all">All Clubs</option>
            <option value="super">Super Bubbles</option>
            <option value="large">Large Clubs (500+ Players)</option>
            <option value="medium">Medium Clubs (300-500 Players)</option>
            <option value="small">Small Clubs (100-300 Players)</option>
            <option value="very-small">Very Small Clubs (Under 100 Players)</option>
            <option value="grouped">Only Clubs in Super Bubbles</option>
        </select>
    </div>

    <!-- Region Filter -->
    <div class="filter-box">
        <label for="region-filter">Region:</label>
        <select id="region-filter" multiple onchange="filterMarkers()">
   <option value="all" selected>All Regions</option>
    <option value="VallÃ©s Occidental">VallÃ©s Occidental</option>
    <option value="VallÃ©s Oriental">VallÃ©s Oriental</option>
</select>

    </div>
</div>


    <!-- ðŸ”¹ MAP CONTAINER -->
    <div id="map"></div>

    <!-- ðŸ”¹ JAVASCRIPT FOR MAP, SUPER BUBBLES, AND FILTERING -->
    <script>
        let markers = []; // Stores all individual club markers
        let superBubbles = []; // Stores all super bubble markers
        let groupedLocations = {}; // âœ… Now it's available everywhere
        
// âœ… Haversine formula to calculate distance between two lat/lng points
function haversineDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Radius of Earth in km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c; // Distance in km
}
        // âœ… Initialize the Map
        window.initMap = function() {
            console.log("Google Maps API loaded successfully and `initMap` is running!");

            window.map = new google.maps.Map(document.getElementById("map"), {
                zoom: 11,  
                center: { lat: 41.5, lng: 2.1 },  
                mapId: "6d21538ba521f729"
            });

            if (!window.map) {
                console.error("Map failed to initialize!");
            }

            // âœ… Fetch the CSV Data
            loadClubData();
        };

        // âœ… Fetch Data from CSV and Add Markers
        function loadClubData() {
            fetch("https://raw.githubusercontent.com/gabort-maps/football-maps/main/clubs.csv")
                .then(response => response.text())
                .then(data => {
                    console.log("CSV File Loaded Successfully!");
                    console.log(data); // âœ… Log the CSV content

                    const rows = data.split("\n").slice(1); // Remove header
                   
                    rows.forEach(row => {
                        const columns = row.split(",");
                        if (columns.length >= 4) {
                           const name = columns[0].trim();
                           const region = columns[1].trim();  // âœ… New: Capture region
                           const lat = parseFloat(columns[2]);
                           const lng = parseFloat(columns[3]);
                           const players = parseInt(columns[4]);

                            if (isNaN(lat) || isNaN(lng) || isNaN(players)) {
                                console.warn(`Skipping invalid row: ${row}`);
                                return; // Skip invalid rows
                            }

                            // âœ… Try to find an existing group within 250 meters
let foundGroup = null;
for (let existingKey in groupedLocations) {
    let existingGroup = groupedLocations[existingKey];
    let distance = haversineDistance(lat, lng, existingGroup.lat, existingGroup.lng);

    if (distance <= 0.25) { // âœ… If within 250m, group them together
        foundGroup = existingGroup;
        break;
    }
}

// âœ… If a group is found, add the club to it
if (foundGroup) {
    foundGroup.clubs.push({ name, players, region });
    foundGroup.totalPlayers += players;
} else {
    groupedLocations[`${lat},${lng}`] = { 
        lat, 
        lng, 
        totalPlayers: players, 
        clubs: [{ name, players, region }],
        region: region  // âœ… Store the region for filtering
    };
}

                        }
                    });

                    console.log("Grouped Locations:", groupedLocations); // âœ… Debugging check

                    // âœ… Now, Create Markers for Both Super Bubbles and Individual Clubs
                   Object.values(groupedLocations).forEach(group => {
    if (group.clubs.length > 1) { // âœ… Only create a Super Bubble if more than 1 club is at this location
        createSuperBubble(group);
    }
    createClubMarkers(group); // âœ… Always create club markers
});

                })
                .catch(error => console.error("Error loading CSV:", error));
        }

        // âœ… Function to Create Super Bubbles
        function createSuperBubble(group) {
            let clubNames = group.clubs.map(c => `${c.name}: ${c.players} players`).join("<br>");

           let superBubbleSize = Math.min(150, 50 + group.totalPlayers / 25); // Max size increased to 150
            let superBubble = document.createElement("div");
            superBubble.style.width = superBubbleSize + "px";
            superBubble.style.height = superBubbleSize + "px";
            superBubble.style.borderRadius = "50%";
            superBubble.style.backgroundColor = "#D3D3D3"; // Light gray
            superBubble.style.display = "flex";
            superBubble.style.justifyContent = "center";
            superBubble.style.alignItems = "center";
            superBubble.style.color = "black";
            superBubble.style.fontWeight = "bold";
            superBubble.style.border = "2px solid white";
            superBubble.innerText = group.totalPlayers;

         // âœ… Debugging: Check if `group.region` exists before assigning
console.log(`Creating Super Bubble at ${group.lat}, ${group.lng} - Region:`, group.region);

let superMarker = new google.maps.marker.AdvancedMarkerElement({
    position: { lat: group.lat - 0.0003, lng: group.lng - 0.0003 },
    title: "Super Bubble",
    content: superBubble,
    zIndex: 1
});

// âœ… Assign region to the super bubble (stored as a JavaScript property)
superMarker.region = group.region; 

// âœ… Debugging Check: Log Assigned Regions
console.log(`Super Bubble at (${group.lat}, ${group.lng}) assigned to region: ${superMarker.region}`);

// âœ… Assign region as a JavaScript property instead of passing it inside the object
superMarker.region = group.region;

console.log(`Super Bubble at (${group.lat}, ${group.lng}) assigned to region: ${group.region}`);


// âœ… Ensure `group.region` exists
if (group.region) {
    superMarker.region = group.region; 
} else {
    console.warn(`âš  Warning: Super Bubble at ${group.lat}, ${group.lng} has no region!`);
}


superMarker.region = group.region; // âœ… Assign region to the super bubble


            superMarker.map = window.map;

            let infoWindow = new google.maps.InfoWindow({
                content: `<div style="text-align:center;">
                            <strong>Football Field</strong><br>${clubNames}
                          </div>`
            });

            superBubble.addEventListener("click", () => {
                infoWindow.open(window.map, superMarker);
            });

            superBubbles.push(superMarker);
        }

        // âœ… Function to Create Individual Club Markers
        function createClubMarkers(group) {
            group.clubs.forEach((club, index) => {
                let clubLat = group.lat + (index * 0.0002); // Small shift to separate markers
                let clubLng = group.lng + (index * 0.0002);

                let clubBubbleSize = Math.min(80, 30 + club.players / 20);
                let clubBubble = document.createElement("div");
                clubBubble.style.width = clubBubbleSize + "px";
                clubBubble.style.height = clubBubbleSize + "px";
                clubBubble.style.borderRadius = "50%";
                // âœ… Assign different colors based on player count
let color = "blue"; // Default

if (club.players > 500) {
    color = "red"; // Large clubs (500+ players)
} else if (club.players > 300) {
    color = "purple"; // Medium clubs (300-500 players)
} else if (club.players > 100) {
    color = "green"; // Small clubs (100-300 players)
} else {
    color = "blue"; // Very small clubs (<100 players)
}

clubBubble.style.backgroundColor = color;

                clubBubble.style.display = "flex";
                clubBubble.style.justifyContent = "center";
                clubBubble.style.alignItems = "center";
                clubBubble.style.color = "white";
                clubBubble.style.fontWeight = "bold";
                clubBubble.style.border = "2px solid white";
                clubBubble.innerText = club.players;

                let clubMarker = new google.maps.marker.AdvancedMarkerElement({
                    position: { lat: clubLat, lng: clubLng },
                    title: club.name,
                    content: clubBubble
                });
  clubMarker.region = group.region; // âœ… Assign region to the marker   
clubMarker.inSuperBubble = (group.clubs.length > 1); // âœ… Marks clubs that are grouped

                clubMarker.map = window.map;

                let clubInfoWindow = new google.maps.InfoWindow({
                    content: `<div style="text-align:center;">
                                <strong>${club.name}</strong><br>Players: ${club.players}
                              </div>`
                });

                clubBubble.addEventListener("click", () => {
                    clubInfoWindow.open(window.map, clubMarker);
                });

                markers.push(clubMarker);
            });
        }

        // âœ… Filtering function
  function filterMarkers() {
    let selectedOptions = Array.from(document.getElementById("filter").selectedOptions).map(opt => opt.value);
    let selectedRegions = Array.from(document.getElementById("region-filter").selectedOptions).map(opt => opt.value);


    markers.forEach(marker => {
        let players = parseInt(marker.content.innerText);
        let showMarker = false;

        // âœ… If "Show All" is selected, show everything
        if (selectedOptions.includes("all")) {
            showMarker = true;
        } else {
            if (selectedOptions.includes("large") && players > 500) showMarker = true;
            if (selectedOptions.includes("medium") && players > 300 && players <= 500) showMarker = true;
            if (selectedOptions.includes("small") && players > 100 && players <= 300) showMarker = true;
            if (selectedOptions.includes("very-small") && players <= 100) showMarker = true;
            if (selectedOptions.includes("grouped") && marker.inSuperBubble) showMarker = true;
        }

        // âœ… Region filtering: Only show if the region matches, or if "All Regions" is selected
if (!selectedRegions.includes("all")) {
    if (!marker.region || !selectedRegions.includes(marker.region)) {
        showMarker = false;
    }
}

marker.map = showMarker ? window.map : null;

    });
}

 superBubbles.forEach(marker => {
    let showSuperBubble = false;

    // âœ… If "All Regions" is selected, show all super bubbles
    if (selectedRegions.includes("all")) {
        showSuperBubble = true;
    } else {
        // âœ… Only show Super Bubbles that match the selected regions
        if (selectedRegions.includes(marker.region)) {
            showSuperBubble = true;
        }
    }

    marker.map = showSuperBubble ? window.map : null;
});


// âœ… Ensure "All Clubs" also shows individual clubs
if (selectedOptions.includes("all")) {
    markers.forEach(marker => {
        marker.map = window.map;
    });
}


    </script>

    <!-- ðŸ”¹ GOOGLE MAPS API -->
    <script async defer 
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCXOfD-urA6wwow_1mz0O-bSJ9PjwXylhQ&callback=initMap&libraries=marker">
    </script>

</body>
</html>
