<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Clubs Map</title>

    <style>
        #map {
            height: 80vh;
            width: 100%;
        }
        #filter-container {
            text-align: center;
            margin: 10px;
        }
        select {
            font-size: 12px;
            padding: 5px;
            width: 280px;
            height: auto;
            max-height: 120px;
            overflow-y: auto;
        }
        #filter option, #region-filter option {
            font-size: 12px;
            padding: 4px;
            white-space: nowrap;
        }
        #filters-wrapper {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 10px 0;
        }
        .filter-box {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #filter, #region-filter {
            font-size: 12px;
            padding: 5px;
            width: 200px;
            height: auto;
            max-height: 120px;
            overflow-y: auto;
        }
    </style>
</head>
<body>

    <!-- ðŸ”¹ FILTER DROPDOWN -->
    <div id="filters-wrapper">
        <!-- Club Filter -->
        <div class="filter-box">
            <label for="filter">Club Size:</label>
            <select id="filter" multiple onchange="filterMarkers()">
                <option value="all">All Clubs</option>
                <option value="super">Super Bubbles</option>
                <option value="large">Large Clubs (500+ Players)</option>
                <option value="medium">Medium Clubs (300-500 Players)</option>
                <option value="small">Small Clubs (100-300 Players)</option>
                <option value="very-small">Very Small Clubs (Under 100 Players)</option>
                <option value="grouped">Only Clubs in Super Bubbles</option>
            </select>
        </div>

        <!-- Region Filter -->
        <div class="filter-box">
            <label for="region-filter">Region:</label>
            <select id="region-filter" multiple onchange="filterMarkers()">
                <option value="all" selected>All Regions</option>
                <option value="VallÃ©s Occidental">VallÃ©s Occidental</option>
                <option value="VallÃ©s Oriental">VallÃ©s Oriental</option>
            </select>
        </div>
    </div>

    <!-- ðŸ”¹ MAP CONTAINER -->
    <div id="map"></div>

    <!-- ðŸ”¹ JAVASCRIPT FOR MAP, SUPER BUBBLES, AND FILTERING -->
    <script>
        let markers = []; // Stores all individual club markers
        let superBubbles = []; // Stores all super bubble markers
        let groupedLocations = {}; // Stores grouped club locations

        // âœ… Haversine formula to calculate distance between two lat/lng points
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        }

        // âœ… Initialize the Map
        window.initMap = function() {
            console.log("Google Maps API loaded successfully and `initMap` is running!");

            window.map = new google.maps.Map(document.getElementById("map"), {
                zoom: 11,
                center: { lat: 41.5, lng: 2.1 },
                mapId: "6d21538ba521f729"
            });

            if (!window.map) {
                console.error("Map failed to initialize!");
            }

            // âœ… Fetch the CSV Data
            loadClubData();
        };

        // âœ… Fetch Data from CSV and Add Markers
        function loadClubData() {
            fetch("https://raw.githubusercontent.com/gabort-maps/football-maps/main/clubs.csv")
                .then(response => response.text())
                .then(data => {
                    console.log("CSV File Loaded Successfully!");
                    console.log(data); // âœ… Log the CSV content

                    const rows = data.split("\n").slice(1); // Remove header
                    rows.forEach(row => {
                        const columns = row.split(",");
                        if (columns.length >= 4) {
                            const name = columns[0].trim();
                            const region = columns[1].trim();
                            const lat = parseFloat(columns[2]);
                            const lng = parseFloat(columns[3]);
                            const players = parseInt(columns[4]);

                            if (isNaN(lat) || isNaN(lng) || isNaN(players)) {
                                console.warn(`Skipping invalid row: ${row}`);
                                return; // Skip invalid rows
                            }

                            // âœ… Group clubs within 250 meters
                            let foundGroup = null;
                            for (let existingKey in groupedLocations) {
                                let existingGroup = groupedLocations[existingKey];
                                let distance = haversineDistance(lat, lng, existingGroup.lat, existingGroup.lng);

                                if (distance <= 0.25) { // âœ… If within 250m, group them together
                                    foundGroup = existingGroup;
                                    break;
                                }
                            }

                            // âœ… If a group is found, add the club to it
                            if (foundGroup) {
                                foundGroup.clubs.push({ name, players, region });
                                foundGroup.totalPlayers += players;
                            } else {
                                groupedLocations[`${lat},${lng}`] = {
                                    lat,
                                    lng,
                                    totalPlayers: players,
                                    clubs: [{ name, players, region }],
                                    region: region
                                };
                            }
                        }
                    });

                    console.log("Grouped Locations:", groupedLocations); // âœ… Debugging check

                    // âœ… Create Markers for Both Super Bubbles and Individual Clubs
                    Object.values(groupedLocations).forEach(group => {
                        if (group.clubs.length > 1) { // âœ… Only create a Super Bubble if more than 1 club is at this location
                            createSuperBubble(group);
                        }
                        createClubMarkers(group); // âœ… Always create club markers
                    });
                })
                .catch(error => console.error("Error loading CSV:", error));
        }

        // âœ… Function to Create Super Bubbles
        function createSuperBubble(group) {
            let clubNames = group.clubs.map(c => `${c.name}: ${c.players} players`).join("<br>");

            let superBubbleSize = Math.min(100, 40 + group.totalPlayers / 30);
            let superBubble = document.createElement("div");
            superBubble.style.width = superBubbleSize + "px";
            superBubble.style.height = superBubbleSize + "px";
            superBubble.style.borderRadius = "50%";
            superBubble.style.backgroundColor = "#D3D3D3"; // Light gray
            superBubble.style.display = "flex";
            superBubble.style.justifyContent = "center";
            superBubble.style.alignItems = "center";
            superBubble.style.color = "black";
            superBubble.style.fontWeight = "bold";
            superBubble.style.border = "2px solid white";
            superBubble.innerText = group.totalPlayers;

            // âœ… Attach the region as a dataset attribute
            superBubble.dataset.region = group.region || "Unknown";

            const superMarker = new google.maps.marker.AdvancedMarkerElement({
                position: { lat: group.lat - 0.0003, lng: group.lng - 0.0003 },
                title: "Super Bubble",
                content: superBubble,
                zIndex: 1
            });

            // âœ… Store the region inside the marker
            superMarker.region = superBubble.dataset.region;

            // âœ… Attach the marker to the map
            superMarker.map = window.map;

            let infoWindow = new google.maps.InfoWindow({
                content: `<div style="text-align:center;">
                            <strong>Football Field</strong><br>${clubNames}
                          </div>`
            });

            superBubble.addEventListener("click", () => {
                infoWindow.open(window.map, superMarker);
            });

            // âœ… Add marker to `superBubbles` array
            superBubbles.push(superMarker);
        }

        // âœ… Function to Create Individual Club Markers
        function createClubMarkers(group) {
            group.clubs.forEach((club, index) => {
                let clubLat = group.lat + (index * 0.0002); // Small shift to separate markers
                let clubLng = group.lng + (index * 0.0002);

                let clubBubbleSize = Math.min(80, 30 + club.players / 20);
                let clubBubble = document.createElement("div");
                clubBubble.style.width = clubBubbleSize + "px";
                clubBubble.style.height = clubBubbleSize + "px";
                clubBubble.style.borderRadius = "50%";
                clubBubble.style.backgroundColor = getColorForPlayers(club.players);
                clubBubble.style.display = "flex";
                clubBubble.style.justifyContent = "center";
                clubBubble.style.alignItems = "center";
                clubBubble.style.color = "white";
                clubBubble.style.fontWeight = "bold";
                clubBubble.style.border = "2px solid white";
                clubBubble.innerText = club.players;

                let clubMarker = new google.maps.marker.AdvancedMarkerElement({
                    position: { lat: clubLat, lng: clubLng },
                    title: club.name,
                    content: clubBubble
                });

                clubMarker.region = group.region; // âœ… Assign region to the marker
                clubMarker.inSuperBubble = (group.clubs.length > 1); // âœ… Marks clubs that are grouped

                clubMarker.map = window.map;

                let clubInfoWindow = new google.maps.InfoWindow({
                    content: `<div style="text-align:center;">
                                <strong>${club.name}</strong><br>Players: ${club.players}
                              </div>`
                });

                clubBubble.addEventListener("click", () => {
                    clubInfoWindow.open(window.map, clubMarker);
                });

                markers.push(clubMarker);
            });
        }

        // âœ… Helper function to get color based on player count
        function getColorForPlayers(players) {
            if (players > 500) return "red"; // Large clubs
            if (players > 300) return "purple"; // Medium clubs
            if (players > 100) return "green"; // Small clubs
            return "blue"; // Very small clubs
        }

        // âœ… Filtering function
        function filterMarkers() {
            let selectedOptions = Array.from(document.getElementById("filter").selectedOptions).map(opt => opt.value);
            let selectedRegions = Array.from(document.getElementById("region-filter").selectedOptions).map(opt => opt.value);

            // Step 1: Filter Individual Club Markers
            markers.forEach(marker => {
                let players = parseInt(marker.content.innerText);
                let region = marker.region;

                // Check if the marker matches the club size filter
                let clubSizeMatch =
                    selectedOptions.includes("all") || // "All Clubs" is selected
                    (selectedOptions.includes("large") && players > 500) ||
                    (selectedOptions.includes("medium") && players > 300 && players <= 500) ||
                    (selectedOptions.includes("small") && players > 100 && players <= 300) ||
                    (selectedOptions.includes("very-small") && players <= 100) ||
                    (selectedOptions.includes("grouped") && marker.inSuperBubble);

                // Check if the marker matches the region filter
                let regionMatch =
                    selectedRegions.includes("all") || // "All Regions" is selected
                    selectedRegions.includes(region);

                // Show or hide the marker based on both filters
                marker.map = clubSizeMatch && regionMatch ? window.map : null;
            });

            // Step 2: Filter Super Bubbles
            superBubbles.forEach(superBubble => {
                let region = superBubble.region;

                // Check if the Super Bubble matches the region filter
                let regionMatch =
                    selectedRegions.includes("all") || // "All Regions" is selected
                    selectedRegions.includes(region);

                // Check if the Super Bubble should be shown based on club size filter
                let clubSizeMatch = true; // Assume it matches by default
                if (!selectedOptions.includes("all") && !selectedOptions.includes("super")) {
                    // Find the group of clubs in this Super Bubble
                    let group = Object.values(groupedLocations).find(g =>
                        g.lat === superBubble.position.lat && g.lng === superBubble.position.lng
                    );

                    // Check if any club in the group matches the club size filter
                    if (group) {
                        clubSizeMatch = group.clubs.some(club =>
                            (selectedOptions.includes("large") && club.players > 500) ||
                            (selectedOptions.includes("medium") && club.players > 300 && club.players <= 500) ||
                            (selectedOptions.includes("small") && club.players > 100 && club.players <= 300) ||
                            (selectedOptions.includes("very-small") && club.players <= 100)
                        );
                    }
                }

                // Show or hide the Super Bubble based on both filters
                superBubble.map = clubSizeMatch && regionMatch ? window.map : null;
            });
        }

        // âœ… Ensure default selections are applied when the page loads
        window.onload = function () {
            document.getElementById("filter").value = "all"; // Default: "All Clubs"
            document.getElementById("region-filter").value = "all"; // Default: "All Regions"
            filterMarkers(); // âœ… Apply filtering immediately
        };
    </script>

    <!-- ðŸ”¹ GOOGLE MAPS API -->
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCXOfD-urA6wwow_1mz0O-bSJ9PjwXylhQ&callback=initMap&libraries=marker">
    </script>
</body>
</html>
