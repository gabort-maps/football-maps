<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Clubs Map</title>

    <style>
        #map {
            height: 80vh;
            width: 100%;
        }
        #filter-container {
            text-align: center;
            margin: 10px;
        }
        select {
            font-size: 16px;
            padding: 5px;
        }
    </style>
</head>
<body>

    <!-- ðŸ”¹ FILTER DROPDOWN -->
    <div id="filter-container">
        <label for="filter">Filter:</label>
       <select id="filter" onchange="filterMarkers()">
    <option value="all">Show All Clubs</option>
    <option value="super">Show Only Super Bubbles</option>
    <option value="large">Show Only Large Clubs (500+ Players)</option>
    <option value="medium">Show Only Medium Clubs (300-500 Players)</option>
    <option value="small">Show Only Small Clubs (100-300 Players)</option>
    <option value="very-small">Show Only Very Small Clubs (Under 100 Players)</option>
</select>

    </div>

    <!-- ðŸ”¹ MAP CONTAINER -->
    <div id="map"></div>

    <!-- ðŸ”¹ JAVASCRIPT FOR MAP, SUPER BUBBLES, AND FILTERING -->
    <script>
        let markers = []; // Stores all individual club markers
        let superBubbles = []; // Stores all super bubble markers

        // âœ… Initialize the Map
        window.initMap = function() {
            console.log("Google Maps API loaded successfully and `initMap` is running!");

            window.map = new google.maps.Map(document.getElementById("map"), {
                zoom: 9,  
                center: { lat: 41.5, lng: 2.1 },  
                mapId: "6d21538ba521f729"
            });

            if (!window.map) {
                console.error("Map failed to initialize!");
            }

            // âœ… Fetch the CSV Data
            loadClubData();
        };

        // âœ… Fetch Data from CSV and Add Markers
        function loadClubData() {
            fetch("https://raw.githubusercontent.com/gabort-maps/football-maps/main/clubs.csv")
                .then(response => response.text())
                .then(data => {
                    console.log("CSV File Loaded Successfully!");
                    console.log(data); // âœ… Log the CSV content

                    const rows = data.split("\n").slice(1); // Remove header
                    let groupedLocations = {}; // Store grouped clubs by location

                    rows.forEach(row => {
                        const columns = row.split(",");
                        if (columns.length >= 4) {
                            const name = columns[0].trim();
                            const lat = parseFloat(columns[1]);
                            const lng = parseFloat(columns[2]);
                            const players = parseInt(columns[3]);

                            if (isNaN(lat) || isNaN(lng) || isNaN(players)) {
                                console.warn(`Skipping invalid row: ${row}`);
                                return; // Skip invalid rows
                            }

                            let key = `${lat},${lng}`;
                            if (!groupedLocations[key]) {
                                groupedLocations[key] = { lat, lng, totalPlayers: 0, clubs: [] };
                            }

                            groupedLocations[key].clubs.push({ name, players });
                            groupedLocations[key].totalPlayers += players;
                        }
                    });

                    console.log("Grouped Locations:", groupedLocations); // âœ… Debugging check

                    // âœ… Now, Create Markers for Both Super Bubbles and Individual Clubs
                    Object.values(groupedLocations).forEach(group => {
                        createSuperBubble(group);
                        createClubMarkers(group);
                    });
                })
                .catch(error => console.error("Error loading CSV:", error));
        }

        // âœ… Function to Create Super Bubbles
        function createSuperBubble(group) {
            let clubNames = group.clubs.map(c => `${c.name}: ${c.players} players`).join("<br>");

            let superBubbleSize = Math.min(100, 40 + group.totalPlayers / 30);
            let superBubble = document.createElement("div");
            superBubble.style.width = superBubbleSize + "px";
            superBubble.style.height = superBubbleSize + "px";
            superBubble.style.borderRadius = "50%";
            superBubble.style.backgroundColor = "#D3D3D3"; // Light gray
            superBubble.style.display = "flex";
            superBubble.style.justifyContent = "center";
            superBubble.style.alignItems = "center";
            superBubble.style.color = "black";
            superBubble.style.fontWeight = "bold";
            superBubble.style.border = "2px solid white";
            superBubble.innerText = group.totalPlayers;

            let superMarker = new google.maps.marker.AdvancedMarkerElement({
                position: { lat: group.lat, lng: group.lng },
                title: "Super Bubble",
                content: superBubble
            });

            superMarker.map = window.map;

            let infoWindow = new google.maps.InfoWindow({
                content: `<div style="text-align:center;">
                            <strong>Football Field</strong><br>${clubNames}
                          </div>`
            });

            superBubble.addEventListener("click", () => {
                infoWindow.open(window.map, superMarker);
            });

            superBubbles.push(superMarker);
        }

        // âœ… Function to Create Individual Club Markers
        function createClubMarkers(group) {
            group.clubs.forEach((club, index) => {
                let clubLat = group.lat + (index * 0.0002); // Small shift to separate markers
                let clubLng = group.lng + (index * 0.0002);

                let clubBubbleSize = Math.min(80, 30 + club.players / 20);
                let clubBubble = document.createElement("div");
                clubBubble.style.width = clubBubbleSize + "px";
                clubBubble.style.height = clubBubbleSize + "px";
                clubBubble.style.borderRadius = "50%";
                // âœ… Assign different colors based on player count
let color = "blue"; // Default

if (club.players > 500) {
    color = "red"; // Large clubs (500+ players)
} else if (club.players > 300) {
    color = "purple"; // Medium clubs (300-500 players)
} else if (club.players > 100) {
    color = "green"; // Small clubs (100-300 players)
} else {
    color = "yellow"; // Very small clubs (<100 players)
}

clubBubble.style.backgroundColor = color;

                clubBubble.style.display = "flex";
                clubBubble.style.justifyContent = "center";
                clubBubble.style.alignItems = "center";
                clubBubble.style.color = "white";
                clubBubble.style.fontWeight = "bold";
                clubBubble.style.border = "2px solid white";
                clubBubble.innerText = club.players;

                let clubMarker = new google.maps.marker.AdvancedMarkerElement({
                    position: { lat: clubLat, lng: clubLng },
                    title: club.name,
                    content: clubBubble
                });

                clubMarker.map = window.map;

                let clubInfoWindow = new google.maps.InfoWindow({
                    content: `<div style="text-align:center;">
                                <strong>${club.name}</strong><br>Players: ${club.players}
                              </div>`
                });

                clubBubble.addEventListener("click", () => {
                    clubInfoWindow.open(window.map, clubMarker);
                });

                markers.push(clubMarker);
            });
        }

        // âœ… Filtering function
      function filterMarkers() {
    let selectedFilter = document.getElementById("filter").value;

    markers.forEach(marker => {
        let players = parseInt(marker.content.innerText); // Extract player count from marker
        if (selectedFilter === "all") {
            marker.map = window.map;
        } else if (selectedFilter === "large" && players > 500) {
            marker.map = window.map;
        } else if (selectedFilter === "medium" && players > 300 && players <= 500) {
            marker.map = window.map;
        } else if (selectedFilter === "small" && players > 100 && players <= 300) {
            marker.map = window.map;
        } else if (selectedFilter === "very-small" && players <= 100) {
            marker.map = window.map;
        } else {
            marker.map = null;
        }
    });

    superBubbles.forEach(marker => {
        marker.map = (selectedFilter === "super" || selectedFilter === "all") ? window.map : null;
    });
}

    </script>

    <!-- ðŸ”¹ GOOGLE MAPS API -->
    <script async defer 
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCXOfD-urA6wwow_1mz0O-bSJ9PjwXylhQ&callback=initMap&libraries=marker">
    </script>

</body>
</html>
