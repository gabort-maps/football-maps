<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Clubs Map</title>

    <style>
        #map {
            height: 80vh;
            width: 100%;
        }
        #filter-container {
            text-align: center;
            margin: 10px;
        }
        select {
            font-size: 16px;
            padding: 5px;
        }
    </style>
</head>
<body>

    <!-- ðŸ”¹ FILTER DROPDOWN -->
    <div id="filter-container">
        <label for="filter">Filter:</label>
        <select id="filter" onchange="filterMarkers()">
            <option value="all">Show All Clubs</option>
            <option value="super">Show Only Super Bubbles</option>
        </select>
    </div>

    <!-- ðŸ”¹ MAP CONTAINER -->
    <div id="map"></div>

    <!-- ðŸ”¹ JAVASCRIPT FOR MAP, SUPER BUBBLES, AND FILTERING -->
    <script>
        let markers = []; // Stores all club markers
        let superBubbles = []; // Stores all super bubbles

        // âœ… Make sure initMap is globally accessible
        window.initMap = function() {
            console.log("Google Maps API loaded successfully and `initMap` is running!");

            var map = new google.maps.Map(document.getElementById("map"), {
                zoom: 9,  
                center: { lat: 41.5, lng: 2.1 },  
                mapId: "6d21538ba521f729"
            });

            if (!map) {
                console.error("Map failed to initialize!");
            }
        };

        // âœ… Log to confirm script is running
        console.log("Custom script loaded successfully.");

       // âœ… Fetch Data from CSV
fetch("https://raw.githubusercontent.com/gabort-maps/football-maps/main/clubs.csv")
    .then(response => response.text())
    .then(data => {
        console.log("CSV File Loaded Successfully!"); // âœ… Debugging message
        console.log(data); // âœ… Log the CSV content to check if it's correct
        
        const rows = data.split("\n").slice(1); // Remove header
        let groupedLocations = {}; // Store grouped clubs by location

        rows.forEach(row => {
            const columns = row.split(",");
            if (columns.length >= 4) {
                const name = columns[0].trim();
                const lat = parseFloat(columns[1]);
                const lng = parseFloat(columns[2]);
                const players = parseInt(columns[3]);

                if (isNaN(lat) || isNaN(lng) || isNaN(players)) {
                    console.warn(`Skipping invalid row: ${row}`);
                    return; // Skip invalid rows
                }

                let key = `${lat},${lng}`;
                if (!groupedLocations[key]) {
                    groupedLocations[key] = { lat, lng, totalPlayers: 0, clubs: [] };
                }

                groupedLocations[key].clubs.push({ name, players });
                groupedLocations[key].totalPlayers += players;
            }
        });

        console.log("Grouped Locations:", groupedLocations); // âœ… Debugging check

        // âœ… Now, create the bubbles
        Object.values(groupedLocations).forEach(group => {
            let clubNames = group.clubs.map(c => `${c.name}: ${c.players} players`).join("<br>");

            let superBubbleSize = Math.min(100, 40 + group.totalPlayers / 30);
            let superBubble = document.createElement("div");
            superBubble.style.width = superBubbleSize + "px";
            superBubble.style.height = superBubbleSize + "px";
            superBubble.style.borderRadius = "50%";
            superBubble.style.backgroundColor = "#D3D3D3";
            superBubble.style.display = "flex";
            superBubble.style.justifyContent = "center";
            superBubble.style.alignItems = "center";
            superBubble.style.color = "black";
            superBubble.style.fontWeight = "bold";
            superBubble.style.border = "2px solid white";
            superBubble.innerText = group.totalPlayers;

            let superMarker = new google.maps.marker.AdvancedMarkerElement({
                map: map,
                position: { lat: group.lat, lng: group.lng },
                title: "Super Bubble",
                content: superBubble
            });

            let infoWindow = new google.maps.InfoWindow({
                content: `<div style="text-align:center;">
                            <strong>Football Field</strong><br>${clubNames}
                          </div>`
            });

            superBubble.addEventListener("click", () => {
                infoWindow.open(map, superMarker);
            });

            superMarker.category = "super";
            superBubbles.push(superMarker);
        });

    })
    .catch(error => console.error("Error loading CSV:", error));

        // Haversine formula to calculate distance between two lat/lng points
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        }

        // Filtering function
        function filterMarkers() {
            let selectedFilter = document.getElementById("filter").value;

            markers.forEach(marker => {
                marker.map = (selectedFilter === "all") ? map : null;
            });

            superBubbles.forEach(marker => {
                marker.map = (selectedFilter === "super" || selectedFilter === "all") ? map : null;
            });
        }
    </script>

    <!-- ðŸ”¹ GOOGLE MAPS API (Ensure This is At the End) -->
    <script async defer 
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCXOfD-urA6wwow_1mz0O-bSJ9PjwXylhQ&callback=initMap&libraries=marker">
    </script>

</body>
</html>
