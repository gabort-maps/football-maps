<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Clubs Map</title>

    <style>
        #map {
            height: 80vh;
            width: 100%;
        }
        #filter-container {
            text-align: center;
            margin: 10px;
        }
        select {
            font-size: 16px;
            padding: 5px;
        }
    </style>
</head>
<body>

    <!-- ðŸ”¹ FILTER DROPDOWN -->
    <div id="filter-container">
        <label for="filter">Filter:</label>
        <select id="filter" onchange="filterMarkers()">
            <option value="all">Show All Clubs</option>
            <option value="super">Show Only Super Bubbles</option>
        </select>
    </div>

    <!-- ðŸ”¹ MAP CONTAINER -->
    <div id="map"></div>

    <!-- ðŸ”¹ JAVASCRIPT FOR MAP, SUPER BUBBLES, AND FILTERING -->
    <script>
        let markers = []; // Stores all club markers
        let superBubbles = []; // Stores all super bubbles

        // âœ… Make sure initMap is globally accessible
        window.initMap = function() {
            console.log("Google Maps API loaded successfully and `initMap` is running!");

            var map = new google.maps.Map(document.getElementById("map"), {
                zoom: 9,  
                center: { lat: 41.5, lng: 2.1 },  
                mapId: "6d21538ba521f729"
            });

            if (!map) {
                console.error("Map failed to initialize!");
            }
        };

        // âœ… Log to confirm script is running
        console.log("Custom script loaded successfully.");

        // Fetch Data from CSV
        fetch("https://raw.githubusercontent.com/gabort-maps/football-maps/main/clubs.csv")
            .then(response => response.text())
            .then(data => {
                const rows = data.split("\n").slice(1); // Remove header
                let groupedLocations = {}; // Store grouped clubs by location

                rows.forEach(row => {
                    const columns = row.split(",");
                    if (columns.length >= 4) {
                        const name = columns[0].trim();
                        const lat = parseFloat(columns[1]);
                        const lng = parseFloat(columns[2]);
                        const players = parseInt(columns[3]);

                        // Check if this club should be grouped with another (within 250m)
                        let foundGroup = null;
                        for (let key in groupedLocations) {
                            let group = groupedLocations[key];
                            let dist = haversineDistance(lat, lng, group.lat, group.lng);

                            if (dist <= 0.25) { // 0.25km = 250m
                                foundGroup = group;
                                break;
                            }
                        }

                        if (foundGroup) {
                            foundGroup.clubs.push({ name, players });
                            foundGroup.totalPlayers += players;
                        } else {
                            groupedLocations[`${lat},${lng}`] = { 
                                lat, lng, totalPlayers: players, clubs: [{ name, players }]
                            };
                        }
                    }
                });
            })
            .catch(error => console.error("Error loading CSV:", error));

        // Haversine formula to calculate distance between two lat/lng points
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        }

        // Filtering function
        function filterMarkers() {
            let selectedFilter = document.getElementById("filter").value;

            markers.forEach(marker => {
                marker.map = (selectedFilter === "all") ? map : null;
            });

            superBubbles.forEach(marker => {
                marker.map = (selectedFilter === "super" || selectedFilter === "all") ? map : null;
            });
        }
    </script>

    <!-- ðŸ”¹ GOOGLE MAPS API (Ensure This is At the End) -->
    <script async defer 
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCXOfD-urA6wwow_1mz0O-bSJ9PjwXylhQ&callback=initMap&libraries=marker">
    </script>

</body>
</html>
